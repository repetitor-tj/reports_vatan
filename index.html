<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–û—Ç–º–µ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö</title>
<style>
  :root{
    --primary:#29A9E8; --danger:#E23D3B; --white:#FFFFFF;
    --switch-on:#22C55E; /* –∑–µ–ª—ë–Ω—ã–π —Ç—É–º–±–ª–µ—Ä */
    --text:#0B1520; --muted:#5A6B7A; --line:#E7EEF3;
    --shadow:0 12px 28px rgba(11,21,32,.08); --radius:16px;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:#F6FAFD; color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{ max-width:560px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
  header h1{ margin:6px 0 2px; font-size:22px }
  header p{ margin:0; color:var(--muted); font-size:13px }

  .card{ background:var(--white); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px }
  label{ font-weight:600; font-size:14px; margin-bottom:6px; display:block }
  input,select,button{ width:100%; border-radius:12px; border:1px solid var(--line); outline:none }
  input,select{ background:#FBFDFF; padding:12px 14px }
  input:focus,select:focus{ border-color:var(--primary) }
  .row{ display:flex; flex-direction:column; gap:12px }

  .btn{
    background:var(--primary); color:#fff; border:0; padding:12px 16px;
    font-weight:700; cursor:pointer; transition:transform .08s ease,opacity .2s ease;
    display:flex; align-items:center; justify-content:center; gap:10px; border-radius:12px;
  }
  .btn:active{ transform:translateY(1px) }
  .btn.secondary{ background:#fff; color:var(--danger); border:1px solid #F3D1CF }
  .btn:disabled{ opacity:.6; cursor:not-allowed }

  .status{ display:flex; align-items:center; gap:10px; background:#F1FAFE; color:#0B6B94; border:1px dashed #CFEAFA; padding:10px 12px; border-radius:12px; font-size:14px }
  .muted{ color:var(--muted); font-size:12px }
  .chip{ display:inline-flex; align-items:center; gap:8px; background:#F2F9FE; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted) }

  .students{ display:flex; flex-direction:column; gap:8px }
  .student{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:12px }
  .mark{ display:flex; align-items:center; gap:10px; color:#475569; font-size:12px }

  /* ===== –¢–£–ú–ë–õ–ï–† (–∑–µ–ª—ë–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫—Ä–∞—Å–Ω—ã–π –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏) ===== */
  :root{
    --present:#22C55E;  /* –∑–µ–ª—ë–Ω—ã–π: –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç) */
    --absent:#E23D3B;   /* –∫—Ä–∞—Å–Ω—ã–π: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç */
  }
  .toggle{
    appearance:none; -webkit-appearance:none;
    width:46px; height:26px; border-radius:999px;
    background:var(--present);
    border:1px solid var(--present);
    position:relative; cursor:pointer; outline:none;
    transition:background .18s ease, border-color .18s ease;
    box-shadow:inset 0 1px 2px rgba(0,0,0,.08);
  }
  .toggle::after{
    content:""; position:absolute; top:50%; left:3px;
    width:20px; height:20px; border-radius:50%; background:#fff;
    transform:translate(0,-50%); transition:transform .18s ease, box-shadow .18s ease;
    box-shadow:0 1.5px 2.5px rgba(0,0,0,.25);
  }
  .toggle:checked{
    background:var(--absent);
    border-color:var(--absent);
  }
  .toggle:checked::after{ transform:translate(20px,-50%) }
  .toggle:active::after{ box-shadow:0 0 0 8px rgba(0,0,0,.04) }

  /* –°–ø–∏–Ω–Ω–µ—Ä */
  .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; animation:spin 1s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Snackbar */
  .snackbar{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%) translateY(20px); background:var(--primary); color:#fff; padding:12px 16px; border-radius:999px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:.25s ease }
  .snackbar.show{ opacity:1; transform:translateX(-50%) translateY(0) }

  .absent-list{ margin:0; padding:0 0 0 18px }
  .absent-title{ font-weight:700; margin:8px 0 6px }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üìÖ –û—Ç–º–µ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö Repetitor.tj</h1>
    <p>–§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∑–∞–Ω—è—Ç–∏–π</p>
  </header>

  <section class="card" aria-live="polite">
    <div class="row">
      <div>
        <label for="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
        <input id="teacher" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∫–æ–µ–≤ –§–∞—Ä—Ä—É—Ö">
        <div class="muted" style="margin-top:4px">–í–∞—à–µ –∏–º—è –ø–æ–ø–∞–¥—ë—Ç –≤ –æ—Ç—á—ë—Ç</div>
      </div>

      <div>
        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç</label>
        <div id="subjectStatus" class="status" style="display:none">
          <span class="spinner" style="border-color:#CFEAFA;border-top-color:#29A9E8"></span><span>–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–∞‚Ä¶</span>
        </div>
        <select id="subject" disabled><option>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option></select>
      </div>

      <div>
        <label for="group">–ì—Ä—É–ø–ø–∞</label>
        <div id="groupStatus" class="status" style="display:none">
          <span class="spinner" style="border-color:#CFEAFA;border-top-color:#29A9E8"></span><span>–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –≥—Ä—É–ø–ø‚Ä¶</span>
        </div>
        <select id="group" disabled><option>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option></select>
      </div>

      <button class="btn" id="showBtn" disabled><span>–ü–æ–∫–∞–∑–∞—Ç—å —É—á–µ–Ω–∏–∫–æ–≤</span></button>
    </div>
  </section>

  <section class="card" id="studentsCard" style="display:none" aria-live="polite">
    <div class="row">
      <div id="studentsStatus" class="status" style="display:none">
        <span class="spinner" style="border-color:#CFEAFA;border-top-color:#29A9E8"></span><span>–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤‚Ä¶</span>
      </div>

      <div class="students" id="students"></div>

      <div class="row">
        <button class="btn" id="sendBtn"><span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</span></button>
        <div class="chip">–û—Ç–º–µ—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö</div>
        <p id="msg" class="muted"></p>

        <!-- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div id="afterSend" style="display:none">
          <div class="absent-title">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ:</div>
          <ul id="absentList" class="absent-list"></ul>
          <div style="height:8px"></div>
          <button class="btn secondary" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å –∂—É—Ä–Ω–∞–ª</button>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="snack" class="snackbar" role="status" aria-live="polite">–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyAcUVGRtx1Cl2UQMNjVjzu4QKGM0hZdeuV8Y5oKW5HOeiEvldjKUPJPyCDL5MuQZF/exec";

  // JSONP helper (–º–∞—Å—Å–∏–≤—ã —Å–∫–ª–µ–∏–≤–∞–µ–º –∑–∞–ø—è—Ç—ã–º–∏)
  function jsonp(url, params, onDone, onFail){
    const cb = "cb"+Math.random().toString(36).slice(2);
    const sp = new URLSearchParams({callback:cb});
    if(params) for(const [k,v] of Object.entries(params)) sp.set(k, Array.isArray(v)?v.join(','):v);
    const s=document.createElement('script');
    window[cb]=d=>{cleanup(); onDone&&onDone(d)};
    s.onerror=()=>{cleanup(); onFail&&onFail(new Error('JSONP load error'))};
    s.src=`${url}?${sp.toString()}`; document.body.appendChild(s);
    function cleanup(){ delete window[cb]; s.remove(); }
  }

  // UI refs
  const $ = id=>document.getElementById(id);
  const subjectSel=$('subject'), groupSel=$('group'), teacherInp=$('teacher');
  const showBtn=$('showBtn'), sendBtn=$('sendBtn');
  const studentsCard=$('studentsCard'), studentsList=$('students');
  const msgEl=$('msg'), snack=$('snack'), afterSend=$('afterSend'), absentList=$('absentList');
  const subjectStatus=$('subjectStatus'), groupStatus=$('groupStatus'), studentsStatus=$('studentsStatus');

  /* === –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è === */
  const LS_KEY_TEACHER = 'ejournal.teacher';
  function loadTeacherFromLS(){
    const v = localStorage.getItem(LS_KEY_TEACHER);
    if (v) teacherInp.value = v;
  }
  function saveTeacherToLS(){
    const v = teacherInp.value.trim();
    if (v) localStorage.setItem(LS_KEY_TEACHER, v);
    else   localStorage.removeItem(LS_KEY_TEACHER);
  }
  let _tSave;
  function debouncedSaveTeacher(){
    clearTimeout(_tSave);
    _tSave = setTimeout(saveTeacherToLS, 300);
  }
  /* === –∫–æ–Ω–µ—Ü –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è === */

  function setLoading(el,on,text){ el.style.display=on?'flex':'none'; if(text) el.querySelector('span:last-child').textContent=text; }
  function setBtnLoading(btn,on,labelLoading){
    if(on){ btn.dataset.label=btn.textContent.trim(); btn.disabled=true; btn.innerHTML=`<span class="spinner"></span><span>${labelLoading}</span>`; }
    else { btn.disabled=false; btn.innerHTML=`<span>${btn.dataset.label||'–ì–æ—Ç–æ–≤–æ'}</span>`; delete btn.dataset.label; }
  }
  function updateShowBtnState(){ showBtn.disabled=!subjectSel.value||!groupSel.value; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showSnack(t='–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'){ snack.textContent=t; snack.classList.add('show'); setTimeout(()=>snack.classList.remove('show'),2000); }

  // –ü—Ä–µ–¥–º–µ—Ç—ã
  function loadSubjects(){
    setLoading(subjectStatus,true,'–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤‚Ä¶'); subjectSel.disabled=true;
    jsonp(SCRIPT_URL,{action:'subjects'},(d)=>{
      subjectSel.innerHTML='<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç ‚Äî</option>';
      if(d&&d.ok) (d.data||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s; subjectSel.appendChild(o); });
      else subjectSel.innerHTML='<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      subjectSel.disabled=false; setLoading(subjectStatus,false); updateShowBtnState();
    },()=>{ subjectSel.innerHTML='<option value="">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</option>'; subjectSel.disabled=false; setLoading(subjectStatus,false); });
  }

  // –ì—Ä—É–ø–ø—ã
  subjectSel.addEventListener('change',()=>{
    studentsCard.style.display='none'; studentsList.innerHTML=''; msgEl.textContent=''; afterSend.style.display='none';
    const subject=subjectSel.value.trim(); if(!subject){ groupSel.innerHTML='<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>'; groupSel.disabled=true; updateShowBtnState(); return; }
    setLoading(groupStatus,true,'–ò–¥–µ—Ç –ø–æ–∏–∫ –≥—Ä—É–ø–ø‚Ä¶'); groupSel.disabled=true;
    jsonp(SCRIPT_URL,{action:'groups',subject},(d)=>{
      groupSel.innerHTML=(d&&d.ok&&d.data.length)?'<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É ‚Äî</option>':'<option value="">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
      if(d&&d.ok) (d.data||[]).forEach(g=>{ const o=document.createElement('option'); o.value=g;o.textContent=g; groupSel.appendChild(o); });
      groupSel.disabled=false; setLoading(groupStatus,false); updateShowBtnState();
    },()=>{ groupSel.innerHTML='<option value="">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</option>'; groupSel.disabled=false; setLoading(groupStatus,false); });
  });

  // –£—á–µ–Ω–∏–∫–∏
  showBtn.addEventListener('click',()=>{
    const subject=subjectSel.value.trim(), group=groupSel.value.trim(); if(!subject||!group) return;
    studentsCard.style.display='block'; studentsList.innerHTML=''; afterSend.style.display='none';
    setBtnLoading(showBtn,true,'–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤‚Ä¶'); setLoading(studentsStatus,true,'–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤‚Ä¶');
    jsonp(SCRIPT_URL,{action:'students',subject,group},(d)=>{
      setBtnLoading(showBtn,false); setLoading(studentsStatus,false);
      if(!(d&&d.ok)){ studentsList.innerHTML='<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
      const arr=d.data||[]; if(!arr.length){ studentsList.innerHTML='<div class="muted">–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º ¬´–ê–∫—Ç–∏–≤–Ω—ã—Ö¬ª —É—á–µ–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>'; return; }
      arr.forEach(st=>{
        const row=document.createElement('div'); row.className='student';
        row.innerHTML=`<div>${escapeHtml(st)}</div>
                       <label class="mark"><input class="toggle" type="checkbox" value="${escapeHtml(st)}"><span>–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span></label>`;
        studentsList.appendChild(row);
      });
    },()=>{ setBtnLoading(showBtn,false); setLoading(studentsStatus,false); studentsList.innerHTML='<div class="muted">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>'; });
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞
  sendBtn.addEventListener('click',()=>{
    const teacher=teacherInp.value.trim(), subject=subjectSel.value.trim(), group=groupSel.value.trim();
    const absent=Array.from(studentsList.querySelectorAll('input.toggle:checked')).map(cb=>cb.value);
    if(!teacher||!subject||!group){ msgEl.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å, –ø—Ä–µ–¥–º–µ—Ç, –≥—Ä—É–ø–ø–∞'; msgEl.className='error'; return; }
    if(!absent.length){ msgEl.textContent='–í—ã –Ω–µ –æ—Ç–º–µ—Ç–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö'; msgEl.className='error'; return; }

    setBtnLoading(sendBtn,true,'–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞—à –æ—Ç—á—ë—Ç‚Ä¶');
    jsonp(SCRIPT_URL,{action:'submitabsences',teacher,subject,group,absent:absent.join(',')},(res)=>{
      setBtnLoading(sendBtn,false);
      if(res&&res.ok){
        // —Å–æ—Ö—Ä–∞–Ω–∏–º –∏–º—è –≤ localStorage
        saveTeacherToLS();

        msgEl.textContent=`–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–µ–≥–æ–¥–Ω—è: ${absent.length}`; msgEl.className='success';
        showSnack('–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        absentList.innerHTML=''; absent.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; absentList.appendChild(li); });
        afterSend.style.display='block';
      }else{
        msgEl.textContent=(res&&res.message)||'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏'; msgEl.className='error';
      }
    },(e)=>{ setBtnLoading(sendBtn,false); msgEl.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message; msgEl.className='error'; });
  });

  $('closeBtn')?.addEventListener('click',()=>{ try{ window.open('','_self'); window.close(); }catch(e){ location.href='about:blank'; } });

  // init
  document.addEventListener('DOMContentLoaded', ()=>{
    loadTeacherFromLS();  // ‚Üê –ø–æ–¥—Å—Ç–∞–≤–∏–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∏–º—è
    loadSubjects();
  });
  groupSel.addEventListener('change',updateShowBtnState);
  teacherInp.addEventListener('input', debouncedSaveTeacher); // ‚Üê –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
</script>
</body>
</html>
